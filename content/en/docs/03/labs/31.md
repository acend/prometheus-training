---
title: "3.1 Tasks: Grafana intro"
weight: 2
sectionnumber: 3.1
onlyWhenNot: baloise
---

### Task {{% param sectionnumber %}}.1: Install Grafana

Similar to the basic setup, we are just going to update our configuration of the ArgoCD application to install and create our Grafana instance. Update your `user-prom-stack.yaml` and update the `grafana.enabled` flag to `true`. Then apply the changes to your ArgoCD application.
`user-prom-stack-app.yaml`:
{{% details title="Hints"%}}

```yaml
---
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: userX-prom-stack
  namespace: argocd
spec:
  destination:
    namespace: userX-monitoring
    server: https://kubernetes.default.svc
  project: default
  source:
    repoURL: 'https://gitea.training.cluster.acend.ch/userX/prometheus-training-lab-setup'
    path: charts/user-monitoring/
    targetRevision: main
    helm:
      values: |
        user: userX
        # alertmanager
        alertmanager:
          enabled: false
        # grafana
        grafana:
          enabled: true
        # prometheus
        prometheus:
          enabled: true
        # pushgateway
        pushgateway:
          enabled: false
        # thanos-ruler
        ruler:
          enabled: false
        # thanos-query
        query:
          enabled: false
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - Replace=true
```

{{% /details %}}

Verify the installation and sync process in the [ArgoCD UI](https://{{% param argoCdUrl %}}). When the application is synchronized successfully navigate to your freshly created Grafana instance: https://{{% param grafanaUrl %}}.

### Task {{% param sectionnumber %}}.2: Add datasources to Grafana

So far Grafana does not know about your prometheus service and needs a datasource configured pointing to the prometheus service. Datasources can be added via config files to Grafana, in our case this will be handled with a secret containing the datasources in the following format:

```yaml
apiVersion: 1

datasources:
  - name: Graphite
    url: http://localhost:$PORT
    user: $USER
    secureJsonData:
      password: $PASSWORD
```

In our example the datasources are already handled by the Helm Chart. Update your ArgoCD application and add the datasource config block like the following:

```yaml
---
[...]
spec:
[...]
  source:
    helm:
      values: |
        # grafana
        grafana:
          datasources:
          - name: prometheus
            access: proxy
            editable: false
            type: prometheus
            url: http://prometheus-operated.<user>-monitoring.svc.cluster.local:9090
```

Commit your changes in the ArgoCD application to your git repository and let it synchronize.

### Task {{% param sectionnumber %}}.3: Configure Prometheus to scrape Grafana metrics

This is repetition. Grafana instruments the Prometheus client library and provides a variety of metrics at the `/metrics` endpoint: <http://{{% param grafanaUrl %}}/metrics>

Configure Prometheus to scrape these metrics. Be careful: Grafana is secured by basic-auth, your ServiceMonitor needs to be aware. The credentials are stored in the `basic-auth` secret in the monitoring namespace.

{{% details title="Hints" mode-switcher="normalexpertmode" %}}

Create a ServiceMonitor `grafana-servicemonitor.yaml` with the following resource:

```yaml
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: grafana-monitor
  namespace: <user>-monitoring
spec:
  endpoints:
    - basicAuth:
        password:
          name: basic-auth
          key: <user>
        username:
          name: basic-auth
          key: grafana_user
      interval: 30s
      port: http
      scheme: http
      path: /metrics
  selector:
    matchLabels:
      app.kubernetes.io/name: grafana

```

And apply the resources:

```
kubectl -n <user>-monitoring create -f `grafana-servicemonitor.yaml`
```

Check if the Grafana instance appears in the targets section of Prometheus (<http://{{% param prometheusUrl %}}/targets>). In addition you can use the following query to show list all metrics of the new target:

{{% /details %}}

### Task {{% param sectionnumber %}}.4: Prometheus/Thanos datasource

To be able to use our Prometheus Server as datasource in Grafana dashboards you have to configure it in Grafana. As we are interested in the global view, we are again going to use the Thanos Querier instead of the Prometheus as a Datasource.

TODO

Visualize the Prometheus metric
```promql
(1 - (
  sum by(instance) (node_memory_MemFree_bytes
  +
  node_memory_Cached_bytes
  +
  node_memory_Buffers_bytes
)
)
/
  sum by(instance) (node_memory_MemTotal_bytes))
* 100 
```
under `Explore` to test your data source.

{{% details title="Hints" mode-switcher="normalexpertmode" %}}

Navigate to **Explore** (Icon on the left navigation menu that looks like a compass)

* Choose **Prometheus** as data source
* Ensure you are using the `Code`-View and not the `Builder`-View
* Enter the above query into the field
* Hit **Run query**

{{% /details %}}
