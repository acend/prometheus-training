---
title: "7.2 Tasks: Alertmanager"
weight: 2
sectionnumber: 7.2
onlyWhenNot: baloise
---

### Task {{% param sectionnumber %}}.1: Configure Slack as alert receiver

In this task we will configure Slack as an alert receiver for Alertmanager alerts.

Again, we can use the Prometheus Operator to reconfigure Alertmanager by using the `AlertmanagerConfig` CR.

```yaml
...
apiVersion: monitoring.coreos.com/v1alpha1
kind: AlertmanagerConfig
metadata:
  name: config-slack
  namespace: $user-monitoring
  labels:
    alertmanagerConfig: $user-monitoring
spec:
  route:
    continue: true
    groupBy:
    - job
    - alertname
    groupWait: 30s
    groupInterval: 5m
    matchers:
      - severity =~ "^(?:critical|warning)$"
    repeatInterval: 12h
    receiver: 'slack-acend'
  receivers:
  - name: 'slack-acend'
    slackConfigs:
    - apiURL: '#<slack_webhook-url>'
      channel: $user-monitoring
      sendResolved: true
      iconURL: https://upload.wikimedia.org/wikipedia/commons/thumb/3/38/Prometheus_software_logo.svg/115px-Prometheus_software_logo.svg.png
      title: |-
        [{{ .Status | toUpper }}{{ if eq .Status "firing" }}:{{ .Alerts.Firing | len }}{{ end }}] {{ .CommonLabels.alertname }} for {{ .CommonLabels.job }}
        {{- if gt (len .CommonLabels) (len .GroupLabels) -}}
          {{" "}}(
          {{- with .CommonLabels.Remove .GroupLabels.Names }}
            {{- range $index, $label := .SortedPairs -}}
              {{ if $index }}, {{ end }}
              {{- $label.Name }}="{{ $label.Value -}}"
            {{- end }}
          {{- end -}}
          )
        {{- end }}
      text: >-
        {{ range .Alerts -}}
        *Alert:* {{ .Annotations.title }}{{ if .Labels.severity }} - `{{ .Labels.severity }}`{{ end }}
        *Description:* {{ .Annotations.description }}
        *Details:*
          {{ range .Labels.SortedPairs }} • *{{ .Name }}:* `{{ .Value }}`
          {{ end }}
        {{ end }}
```

The configuration will be rendered to valid config for Alertmanager in the background.


### Task {{% param sectionnumber %}}.2: Send a test alert

In this task you can use the [amtool](https://github.com/prometheus/alertmanager#amtool) command to send a test alert.

To send a test alert with the labels `alertname=Up` and `node=bar` you can simply execute the following command.

```bash
user=<user>
kubectl --namespace $$user-monitoring exec -it sts/alertmanager-apps-monitoring -- sh
amtool alert add --alertmanager.url=http://localhost:9093 alertname=Up node=bar
```

Check in the [Alertmanger web UI](http://{{% param replacePlaceholder.alertmanager %}}) if you see the test alert with the correct labels set.


### Task {{% param sectionnumber %}}.3: Show the routing tree

Show routing tree:

```bash
user=<user>
kubectl --namespace $$user-monitoring exec -it sts/alertmanager-apps-monitoring -- sh
amtool config routes --config.file /etc/alertmanager/alertmanager.yml
```

Depending on the configured receivers your output might vary.

If you only configured the slack receiver, the output will look similar to this:

```bash
user=<user>
kubectl --namespace $$user-monitoring exec -it sts/alertmanager-apps-monitoring -- \
amtool config routes --config.file /etc/alertmanager/alertmanager.yml
Routing tree:
.
└── default-route  receiver: default
    ├── {severity=~"^(?:critical|warning)$"}  continue: true  receiver: slack-acend
```


### Task {{% param sectionnumber %}}.5: Test your alert receivers

Add a test alert and check if your defined target slack channel receives the alert. It can take up to 5 minutes as the alarms are grouped together based on the [group_interval](https://prometheus.io/docs/alerting/latest/configuration/#route).


```bash
user=<user>
kubectl --namespace $$user-monitoring exec -it sts/alertmanager-apps-monitoring -- sh
amtool alert add --alertmanager.url=http://localhost:9093 alertname=snafu env=dev severity=critical
```

It is also advisable to validate the routing configuration against a test dataset to avoid unintended changes. With the option `--verify.receivers` the expected output can be specified:

```bash
team=<team>
kubectl --namespace $$user-monitoring exec -it sts/alertmanager-apps-monitoring -- sh
amtool config routes test --config.file /etc/alertmanager/alertmanager.yml --verify.receivers=acend-slack env=dev severity=info
```

```bash
default
WARNING: Expected receivers did not match resolved receivers.
```

```bash
team=<team>
kubectl --namespace $$user-monitoring exec -it sts/alertmanager-apps-monitoring -- sh
amtool config routes test --config.file /etc/alertmanager/alertmanager.yml --verify.receivers=acend-slack env=dev severity=critical
```
