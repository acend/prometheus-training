---
title: "1.1 Tasks: Setup"
weight: 1
onlyWhenNot: baloise

sectionnumber: 1.1
---

### Task {{% param sectionnumber %}}.1: Deploy example application TODO: needs to be fixed, taken from current 1.2 lab

Deploy the Acend example Python application, which provides application metrics at `/metrics` by creating the following file in your repo:

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  creationTimestamp: null
  labels:
    app: example-web-python
  name: example-web-python
spec:
  replicas: 1
  selector:
    matchLabels:
      app: example-web-python
  template:
    metadata:
      labels:
        app: example-web-python
    spec:
      containers:
      - image: quay.io/acend/example-web-python
        name: example-web-python
```

Use the following command to verify whether pod `example-web-python` is Ready and Running. (use CTRL C to exit the command)

```bash
{{% param cliToolName %}} get pod -w
```

We also need to create a Service for the new application. Create a file with the following content:
```yaml
apiVersion: v1
kind: Service
metadata:
  labels:
    app: example-web-python
    prometheus-monitoring: 'true'
  name: example-web-python
spec:
  ports:
    - name: http
      port: 5000
      protocol: TCP
      targetPort: 5000
  selector:
    app: example-web-python
  type: ClusterIP
```

This created a so-called [Kubernetes Service](https://kubernetes.io/docs/concepts/services-networking/service/)

```bash
{{% param cliToolName %}} get services
```

### Task {{% param sectionnumber %}}.2: Create a ServiceMonitor

Check whether the application metrics are actually exposed by opening a shell within the container and curling the metrics endpoint.

```bash
# get the pod name
{{% param cliToolName %}} get pod
# exec curl within the pod
{{% param cliToolName %}} exec -it <pod-name> -- curl http://localhost:5000/metrics
```
Should result in something like:

```promql
# HELP python_gc_objects_collected_total Objects collected during gc
# TYPE python_gc_objects_collected_total counter
python_gc_objects_collected_total{generation="0"} 541.0
python_gc_objects_collected_total{generation="1"} 344.0
python_gc_objects_collected_total{generation="2"} 15.0
...
```

Since our newly deployed application now exposes metrics, the next thing we need to do, is to tell our Prometheus server to scrape metrics from the Kubernetes deployment. In a highly dynamic environment like Kubernetes this is done with so called Service Discovery.

**Task description**:

Create a ServiceMonitor for the example application

* Create a ServiceMonitor, which will configure Prometheus to scrape metrics from the example-web-python application every 30 seconds.

For this to work, you need to ensure:

* The example-web-python Service is labeled correctly and matches the labels you've defined in your ServiceMonitor.
* The port name in your ServiceMonitor configuration matches the port name in the Service definition.
  * hint: check with `{{% param cliToolName %}} get service example-web-python -o yaml`
* Verify the target in the Prometheus user interface.

{{% details title="Hints" mode-switcher="normalexpertmode" %}}

Create the following ServiceMonitor:
```yaml
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  labels:
    app.kubernetes.io/name: example-web-python
  name: example-web-python-monitor
spec:
  endpoints:
    - interval: 30s
      port: http
      scheme: http
      path: /metrics
  selector:
    matchLabels:
      prometheus-monitoring: 'true'
```

Verify that the target gets scraped in the [Prometheus user interface](http://{{% param replacePlaceholder.k8sPrometheus %}}/targets). Target name: `serviceMonitor/<TODO>/example-web-python-monitor/0` (it may take up to a minute for Prometheus to load the new configuration and scrape the metrics).

{{% /details %}}
